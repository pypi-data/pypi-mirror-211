"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["app_views_starfish_views_spans_spansView_tsx"],{"./app/views/starfish/types.tsx":(e,t,a)=>{let n;a.d(t,{r:()=>n}),function(e){e.HTTP="http",e.DB="db",e.NONE="none",e.ALL=""}(n||(n={}))},"./app/views/starfish/views/spans/queries.tsx":(e,t,a)=>{a.d(t,{Au:()=>o,FU:()=>r});var n=a("../node_modules/moment/moment.js"),s=a.n(n),i=a("./app/views/starfish/utils/dates.tsx");const r=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;const{start_timestamp:r,end_timestamp:o}=(0,i.SW)(e),d=t.filter(Boolean);return`SELECT\n    group_id, span_operation, description, domain,\n    sum(exclusive_time) as total_exclusive_time,\n    uniq(transaction) as transactions,\n    quantile(0.95)(exclusive_time) as p95,\n    quantile(0.75)(exclusive_time) as p75,\n    quantile(0.50)(exclusive_time) as p50,\n    count() as count,\n    (divide(count, ${(s()(o??void 0).unix()-s()(r).unix())/60}) AS epm)\n    FROM spans_experimental_starfish\n    WHERE greaterOrEquals(start_timestamp, '${r}')\n    ${d.length>0?"AND":""}\n    ${d.join(" AND ")}\n    ${o?`AND lessOrEquals(start_timestamp, '${o}')`:""}\n    GROUP BY group_id, span_operation, domain, description\n    ORDER BY ${a??"count"} desc\n    ${n?`LIMIT ${n}`:""}`},o=(e,t)=>{const{start_timestamp:a,end_timestamp:n}=(0,i.SW)(e);return`\n    SELECT\n    group_id, span_operation,\n    toStartOfInterval(start_timestamp, INTERVAL 1 DAY) as interval,\n    quantile(0.50)(exclusive_time) as p50_trend,\n    quantile(0.95)(exclusive_time) as p95_trend,\n    divide(count(), multiply(24, 60)) as throughput\n    FROM spans_experimental_starfish\n    WHERE greaterOrEquals(start_timestamp, '${a}')\n    ${n?`AND lessOrEquals(start_timestamp, '${n}')`:""}\n    AND group_id IN (${t.map((e=>`'${e}'`)).join(",")})\n    GROUP BY group_id, span_operation, interval\n    ORDER BY interval asc\n  `}},"./app/views/starfish/views/spans/spansTable.tsx":(e,t,a)=>{a.d(t,{ZP:()=>x});var n=a("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),s=(a("../node_modules/core-js/modules/es.array.push.js"),a("../node_modules/@emotion/react/dist/emotion-element-6a883da9.browser.esm.js")),i=a("../node_modules/moment/moment.js"),r=a.n(i),o=a("./app/components/duration.tsx"),d=a("./app/components/gridEditable/index.tsx"),p=a("./app/components/gridEditable/sortLink.tsx"),l=a("./app/components/links/link.tsx"),u=a("./app/utils/formatters.tsx"),m=a("./app/utils/useLocation.tsx"),c=a("./app/views/starfish/colours.tsx"),v=a("./app/views/starfish/components/formattedCode.tsx"),h=a("./app/views/starfish/components/sparkline.tsx"),_=a("./app/views/starfish/queries/useApplicationMetrics.tsx"),y=a("./app/views/starfish/types.tsx"),f=a("./app/views/starfish/utils/zeroFillSeries.tsx"),g=a("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function x(e){let{moduleName:t,spansData:a,orderBy:n,onSetOrderBy:i,spansTrendsData:p,isLoading:v,columnOrder:y}=e;const x=(0,m.T)(),E=(0,s.u)(),{data:T}=(0,_.T)(),L={p50_trend:{},p95_trend:{},throughput:{}};p?.forEach((e=>{let{group_id:t,span_operation:a,interval:n,...s}=e;["p50_trend","p95_trend","throughput"].forEach((e=>a in L[e]?t in L[e][a]?L[e][a][t].push({name:n,value:s[e]}):L[e][a][t]=[{name:n,value:s[e]}]:L[e][a]={[t]:[{name:n,value:s[e]}]}))}));const A=a?.map((e=>{const{group_id:t,span_operation:a}=e;if(void 0===L.p50_trend?.[a])return e;const n={seriesName:"p50_trend",data:L.p50_trend[a][t]},s={seriesName:"p95_trend",data:L.p95_trend[a][t]},i={seriesName:"throughput_trend",data:L.throughput[a][t]},o=(0,f.b)(n,r().duration(1,"day")),d=(0,f.b)(s,r().duration(1,"day")),p=(0,f.b)(i,r().duration(1,"day"));return{...e,app_impact:(0,u.rl)(e.total_exclusive_time/T["sum(span.duration)"]),p50_trend:o,p95_trend:d,throughput_trend:p}}));return(0,g.tZ)(d.ZP,{isLoading:v,data:A,columnOrder:y??b(t),columnSortBy:n?[]:[{key:n,order:"desc"}],grid:{renderHeadCell:w(n,i),renderBodyCell:(e,t)=>function(e,t,a){if("throughput_trend"===e.key&&t[e.key]){const n=(0,h.Fk)(`${t.epm.toFixed(2)}`,t.epm,a);return(0,g.tZ)(h.ZP,{color:c.SQ,series:t[e.key],width:e.width?e.width-e.width/5:void 0,markLine:n})}if("p50_trend"===e.key&&t[e.key]){const n=(0,h.Fk)(`${(0,u.g9)(t.p50/1e3,2,!0)}`,t.p50,a);return(0,g.tZ)(h.ZP,{color:c.v$,series:t[e.key],width:e.width?e.width-e.width/5:void 0,markLine:n})}return"description"===e.key?(0,g.tZ)(Z,{children:(0,g.tZ)(l.Z,{to:`/starfish/span/${t.group_id}`,children:"db"===t.span_operation?(0,g.tZ)(S,{children:t.formatted_desc}):t.description||"<null>"})}):e.key.toString().match(/^p\d\d/)||"total_exclusive_time"===e.key?(0,g.tZ)(o.Z,{seconds:t[e.key]/1e3,fixedDigits:2,abbreviation:!0}):t[e.key]}(e,t,E)},location:x})}function w(e,t){return function(a){return(0,g.tZ)(p.Z,{align:"left",canSort:!0,direction:e===a.key?"desc":void 0,onClick:()=>{t(`${a.key}`)},title:a.name,generateSortLink:()=>({...location})})}}function b(e){const t=function(e){return e===y.r.HTTP?"URL":e===y.r.DB?"Query":"Description"}(e),a=function(e){return e===y.r.HTTP?"Host":e===y.r.DB?"Table":"Domain"}(e);return[{key:"span_operation",name:"Operation",width:d.z7},{key:"description",name:t,width:d.z7},e!==y.r.ALL&&{key:"domain",name:a,width:d.z7},{key:"throughput_trend",name:"Throughput",width:175},{key:"p50_trend",name:"Duration (p50)",width:175},{key:"app_impact",name:"App Impact",width:d.z7}].filter((e=>Boolean(e)))}x.displayName="SpansTable";const S=(0,n.Z)(v.K,{target:"e5rrkpr1"})({name:"6wvegy",styles:"background:none;text-overflow:ellipsis"}),Z=(0,n.Z)("span",{target:"e5rrkpr0"})({name:"12wal98",styles:"text-overflow:ellipsis;overflow:hidden;white-space:nowrap"})},"./app/views/starfish/views/spans/spansView.tsx":(e,t,a)=>{a.d(t,{T:()=>X,Z:()=>U});var n=a("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),s=(a("../node_modules/core-js/modules/es.array.push.js"),a("../node_modules/react/index.js")),i=a("../node_modules/@tanstack/react-query/build/lib/useQuery.mjs"),r=a("./app/components/datePageFilter.tsx"),o=a("./app/styles/space.tsx"),d=a("./app/utils/useLocation.tsx"),p=a("./app/utils/usePageFilters.tsx"),l=a("./app/views/starfish/types.tsx"),u=a("./app/views/starfish/utils/constants.tsx"),m=a("../node_modules/react-router/es/index.js"),c=a("./app/components/compactSelect/index.tsx"),v=a("./app/locale.tsx"),h=a("./app/utils/discover/eventView.tsx"),_=a("./app/utils/discover/types.tsx"),y=a("./app/views/starfish/utils/useSpansQuery.tsx"),f=a("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function g(e){let{value:t="",moduleName:a=l.r.ALL}=e;const{selection:n}=(0,p.Z)(),s=(0,d.T)(),i=function(e){return`SELECT action as "span.action", count()\n    FROM spans_experimental_starfish\n    WHERE 1 = 1\n    ${e?`AND module = '${e}'`:""}\n    AND action != ''\n    GROUP BY action\n    ORDER BY count() DESC\n    LIMIT 25\n  `}(a),r=b(a,n),o=a===l.r.HTTP,{data:u}=(0,y.bB)({eventView:r,queryString:i,initialData:[],enabled:Boolean(i&&!o)}),v=o?x:[{value:"",label:"All"},...u.map((e=>({value:e["span.action"],label:e["span.action"]})))];return(0,f.tZ)(c.Z,{triggerProps:{prefix:w[a]},value:t,options:v??[],onChange:e=>{m.browserHistory.push({...s,query:{...s.query,action:e.value}})}})}g.displayName="ActionSelector";const x=[{value:"",label:"All"},...["GET","POST","PUT","DELETE"].map((e=>({value:e,label:e})))],w={http:(0,v.t)("HTTP Method"),db:(0,v.t)("SQL Command"),none:(0,v.t)("Action"),"":(0,v.t)("Action")};function b(e,t){return h.ZP.fromSavedQuery({name:"",fields:["span.action","count()"],orderby:"-count",query:e?`!span.action:"" span.module:${e}`:'!span.action:""',dataset:_.as.SPANS_METRICS,start:t.datetime.start??void 0,end:t.datetime.end??void 0,range:t.datetime.period??void 0,projects:[1],version:2})}function S(e){let{value:t="",moduleName:a=l.r.ALL}=e;const{selection:n}=(0,p.Z)(),s=(0,d.T)(),i=function(e){return`SELECT domain as "span.domain", count()\n    FROM spans_experimental_starfish\n    WHERE 1 = 1\n    ${e?`AND module = '${e}'`:""}\n    AND domain != ''\n    GROUP BY domain\n    ORDER BY count() DESC\n    LIMIT 25\n  `}(a),r=E(a,n),{data:o}=(0,y.bB)({eventView:r,queryString:i,initialData:[],enabled:Boolean(i)}),u=[{value:"",label:"All"},...o.map((e=>({value:e["span.domain"],label:e["span.domain"]})))];return(0,f.tZ)(c.Z,{triggerProps:{prefix:Z[a]},value:t,options:u??[],onChange:e=>{m.browserHistory.push({...s,query:{...s.query,domain:e.value}})}})}S.displayName="DomainSelector";const Z={http:(0,v.t)("Host"),db:(0,v.t)("Table"),none:(0,v.t)("Domain"),"":(0,v.t)("Domain")};function E(e,t){return h.ZP.fromSavedQuery({name:"",fields:["span.domain","count()"],orderby:"-count",query:e?`!span.domain:"" span.module:${e}`:'!span.domain:""',dataset:_.as.SPANS_METRICS,start:t.datetime.start??void 0,end:t.datetime.end??void 0,range:t.datetime.period??void 0,projects:[1],version:2})}function T(e){let{value:t="",moduleName:a=l.r.ALL}=e;const{selection:n}=(0,p.Z)(),s=(0,d.T)(),i=function(e){return`SELECT span_operation as "span.op", count()\n    FROM spans_experimental_starfish\n    WHERE span_operation != ''\n    ${e!==l.r.ALL?`AND module = '${e}'`:""}\n    GROUP BY span_operation\n    ORDER BY count() DESC\n    LIMIT 25\n  `}(a),r=L(a,n),{data:o}=(0,y.bB)({eventView:r,queryString:i,initialData:[],enabled:Boolean(i)}),u=[{value:"",label:"All"},...o.map((e=>({value:e["span.op"],label:e["span.op"]})))];return(0,f.tZ)(c.Z,{triggerProps:{prefix:(0,v.t)("Operation")},value:t,options:u??[],onChange:e=>{m.browserHistory.push({...s,query:{...s.query,span_operation:e.value}})}})}function L(e,t){return h.ZP.fromSavedQuery({name:"",fields:["span.op","count()"],orderby:"-count",query:e?`span.module:${e}`:"",start:t.datetime.start??void 0,end:t.datetime.end??void 0,range:t.datetime.period??void 0,dataset:_.as.SPANS_METRICS,projects:[1],version:2})}T.displayName="SpanOperationSelector";var A=a("../node_modules/moment/moment.js"),D=a.n(A),$=a("./app/views/starfish/colours.tsx"),k=a("./app/views/starfish/components/breakdownBar.tsx"),N=a("./app/views/starfish/components/chart.tsx"),q=a("./app/views/starfish/components/chartPanel.tsx"),O=a("./app/views/starfish/utils/dates.tsx"),B=a("./app/views/starfish/utils/zeroFillSeries.tsx");function R(e){let{moduleName:t,appliedFilters:a}=e;const n=(0,d.T)(),{selection:s}=(0,p.Z)(),[i,r,o]=s.datetime.period?.match(O.Pr)??[],l=r&&o?D()().subtract(r,o):D()(s.datetime.start),u=D()(s.datetime.end??void 0),m=j(t,s,a),c=F(t,s,a),{isLoading:h,data:_}=(0,y.bB)({eventView:c,queryString:`${m}&referrer=span-time-charts`,initialData:[]}),{span_operation:g,action:x,domain:w}=n.query,b=(0,k.c_)(g,x,w),S={[b]:_},Z=Object.keys(S).map((e=>{const t=S[e];return(0,B.b)({seriesName:b??"Throughput",data:t.map((e=>({value:e["spm()"],name:e.interval})))},D().duration(1,"day"),l,u)})),E=Object.keys(S).map((e=>{const t=S[e];return(0,B.b)({seriesName:b??"p50()",data:t.map((e=>({value:e["p50(span.duration)"],name:e.interval})))},D().duration(1,"day"),l,u)}));return(0,N.K)([!h]),(0,f.BX)(M,{children:[(0,f.tZ)(H,{children:(0,f.tZ)(q.Z,{title:(0,v.t)("Throughput"),children:(0,f.tZ)(N.Z,{statsPeriod:"24h",height:100,data:Z,start:"",end:"",loading:h,utc:!1,grid:{left:"0",right:"0",top:"8px",bottom:"0"},definedAxisTicks:4,stacked:!0,isLineChart:!0,chartColors:[$.SQ],disableXAxis:!0,tooltipFormatterOptions:{valueFormatter:e=>`${e.toFixed(3)} / ${(0,v.t)("min")}`}})})}),(0,f.tZ)(H,{children:(0,f.tZ)(q.Z,{title:(0,v.t)("Duration (P50)"),children:(0,f.tZ)(N.Z,{statsPeriod:"24h",height:100,data:E,start:"",end:"",loading:h,utc:!1,grid:{left:"0",right:"0",top:"8px",bottom:"0"},definedAxisTicks:4,stacked:!0,isLineChart:!0,chartColors:[$.v$],disableXAxis:!0})})})]})}R.displayName="SpanTimeCharts";const j=(e,t,a)=>{const{start_timestamp:n,end_timestamp:s}=(0,O.SW)(t.datetime),i=C(e,a);return`SELECT\n    divide(count(), multiply(12, 60)) as "spm()",\n    quantile(0.50)(exclusive_time) AS "p50(span.duration)",\n    toStartOfInterval(start_timestamp, INTERVAL 1 DAY) as interval\n    FROM spans_experimental_starfish\n    WHERE greaterOrEquals(start_timestamp, '${n}')\n    ${s?`AND lessOrEquals(start_timestamp, '${s}')`:""}\n    ${i?`AND ${i}`:""}\n    GROUP BY interval\n    ORDER BY interval ASC\n  `},P=["span_operation","domain","action"],C=(e,t)=>{const a=Object.keys(t).filter((e=>P.includes(e))).filter((e=>Boolean(t[e]))).map((e=>`${e} = '${t[e]}'`));return e!==l.r.ALL&&a.push(`module = '${e}'`),a.join(" ")},F=(e,t,a)=>{const n=I(e,a);return h.ZP.fromSavedQuery({name:"",fields:[""],yAxis:["spm()","p50(span.duration)"],query:n,dataset:_.as.SPANS_METRICS,start:t.datetime.start??void 0,end:t.datetime.end??void 0,range:t.datetime.period??void 0,projects:[1],version:2})},I=(e,t)=>{const a=Object.keys(t).filter((e=>P.includes(e))).filter((e=>Boolean(t[e]))).map((e=>`${e}:${t[e]}`));return e!==l.r.ALL&&a.push(`span.module:'${e}'`),a.join(" ")},M=(0,n.Z)("div",{target:"e1evs38o1"})("display:flex;flex-direction:row;flex-wrap:wrap;gap:",(0,o.D)(2),";"),H=(0,n.Z)("div",{target:"e1evs38o0"})({name:"82a6rk",styles:"flex:1"});var Y=a("./app/views/starfish/views/spans/queries.tsx"),W=a("./app/views/starfish/views/spans/spansTable.tsx");const Q=25;function U(e){const t=(0,d.T)(),a=t.query,n=(0,p.Z)(),[o,m]=(0,s.useState)({orderBy:"total_exclusive_time"}),{orderBy:c}=o,v=X(e.moduleName||l.r.ALL,t),h=(0,Y.FU)(n.selection.datetime,v,c,Q),{isLoading:_,data:y}=(0,i.a)({queryKey:["spans",h],queryFn:()=>fetch(`${u.M}/?query=${h}&format=sql`).then((e=>e.json())),retry:!1,refetchOnWindowFocus:!1,initialData:[]}),x=y.map((e=>{let{group_id:t}=e;return t})),{isLoading:w,data:b}=(0,i.a)({queryKey:["spansTrends"],queryFn:()=>fetch(`${u.M}/?query=${(0,Y.Au)(n.selection.datetime,x)}`).then((e=>e.json())),retry:!1,refetchOnWindowFocus:!1,initialData:[],enabled:x.length>0});return(0,f.BX)(s.Fragment,{children:[(0,f.BX)(G,{children:[(0,f.tZ)(r.Z,{alignDropdown:"left"}),(0,f.tZ)(T,{moduleName:e.moduleName,value:a.span_operation||""}),(0,f.tZ)(S,{moduleName:e.moduleName,value:a.domain||""}),(0,f.tZ)(g,{moduleName:e.moduleName,value:a.action||""})]}),(0,f.tZ)(V,{children:(0,f.tZ)(R,{moduleName:e.moduleName||l.r.ALL,appliedFilters:a})}),(0,f.tZ)(V,{children:(0,f.tZ)(W.ZP,{moduleName:e.moduleName||l.r.ALL,isLoading:_||w,spansData:y,orderBy:c,onSetOrderBy:e=>m({orderBy:e}),spansTrendsData:b})})]})}U.displayName="SpansView";const V=(0,n.Z)("div",{target:"e1ojq8vq1"})("margin:",(0,o.D)(2),";"),G=(0,n.Z)(V,{target:"e1ojq8vq0"})("display:flex;flex-direction:row;gap:",(0,o.D)(1),";margin-bottom:",(0,o.D)(2),";"),z=["span_operation","domain","action"],X=(e,t)=>{const{query:a}=t,n=Object.keys(a).filter((e=>z.includes(e))).filter((e=>Boolean(a[e]))).map((e=>`${e} = '${a[e]}'`));return e!==l.r.ALL&&n.push(`module = '${e}'`),n}}}]);
//# sourceMappingURL=../sourcemaps/app_views_starfish_views_spans_spansView_tsx.d52e0e2b80f456234a04d5e505e9f668.js.map