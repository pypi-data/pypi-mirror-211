"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["SuperuserAccessForm","U2fSign"],{"./app/components/superuserAccessForm.tsx":(e,t,s)=>{s.r(t),s.d(t,{default:()=>Z});var n=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=s("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),o=s("../node_modules/react/index.js"),a=s("../node_modules/lodash/trimEnd.js"),i=s.n(a),l=s("./app/actionCreators/account.tsx"),c=s("./app/components/alert.tsx"),d=s("./app/components/button.tsx"),u=s("./app/components/forms/form.tsx"),p=s("./app/components/hook.tsx"),h=s("./app/components/themeAndStyleProvider.tsx"),m=s("./app/components/u2f/u2fContainer.tsx"),f=s("./app/constants/superuserAccessErrors.tsx"),g=s("./app/locale.tsx"),y=s("./app/stores/configStore.tsx"),S=s("./app/styles/space.tsx"),w=s("./app/utils/withApi.tsx"),b=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");class A extends o.Component{constructor(){super(...arguments),(0,n.Z)(this,"state",{authenticators:[],error:!1,errorType:"",showAccessForms:!0,superuserAccessCategory:"",superuserReason:""}),(0,n.Z)(this,"handleSubmitCOPS",(()=>{this.setState({superuserAccessCategory:"cops_csm",superuserReason:"COPS and CSM use"})})),(0,n.Z)(this,"handleSubmit",(async e=>{const{api:t}=this.props,{superuserAccessCategory:s,superuserReason:n,authenticators:r}=this.state,o=y.Z.get("disableU2FForSUForm"),a=s||e.superuserAccessCategory,i=n||e.superuserReason;if(r.length||o)if(this.state.showAccessForms&&!o)this.setState({showAccessForms:!1,superuserAccessCategory:a,superuserReason:i});else try{await t.requestPromise("/auth/",{method:"PUT",data:e}),this.handleSuccess()}catch(e){this.handleError(e)}else this.handleError(f.S.noAuthenticator)})),(0,n.Z)(this,"handleU2fTap",(async e=>{const{api:t}=this.props;try{e.isSuperuserModal=!0,e.superuserAccessCategory=this.state.superuserAccessCategory,e.superuserReason=this.state.superuserReason,await t.requestPromise("/auth/",{method:"PUT",data:e}),this.handleSuccess()}catch(e){throw this.setState({showAccessForms:!0}),e}})),(0,n.Z)(this,"handleSuccess",(()=>{window.location.reload()})),(0,n.Z)(this,"handleError",(e=>{let t="";t=403===e.status?"no_u2f"===e.responseJSON.detail.code?f.S.noAuthenticator:f.S.invalidPassword:401===e.status?f.S.invalidSSOSession:400===e.status?f.S.invalidAccessCategory:e===f.S.noAuthenticator?f.S.noAuthenticator:f.S.unknownError,this.setState({error:!0,errorType:t,showAccessForms:!0})})),(0,n.Z)(this,"handleLogout",(async()=>{const{api:e}=this.props;try{await(0,l.kS)(e)}catch{}const t=`/auth/login/?next=${encodeURIComponent(window.location.href)}`,{superuserUrl:s}=window.__initialData.links;if(window.__initialData?.customerDomain&&s){const e=`${i()(s,"/")}${t}`;window.location.assign(e)}else window.location.assign(t)}))}componentDidMount(){this.getAuthenticators()}async getAuthenticators(){const{api:e}=this.props;try{const t=await e.requestPromise("/authenticators/");this.setState({authenticators:t??[]})}catch{}}render(){const{authenticators:e,error:t,errorType:s,showAccessForms:n}=this.state;return s===f.S.invalidSSOSession?(this.handleLogout(),null):(0,b.tZ)(h.S,{children:(0,b.BX)(u.Z,{submitLabel:(0,g.t)("Continue"),onSubmit:this.handleSubmit,initialData:{isSuperuserModal:!0},extraButton:(0,b.tZ)(E,{children:(0,b.tZ)(d.zx,{type:"submit",onClick:this.handleSubmitCOPS,children:(0,g.t)("COPS/CSM")})}),resetOnError:!0,children:[t&&(0,b.tZ)(v,{type:"error",showIcon:!0,children:s}),n&&(0,b.tZ)(p.Z,{name:"component:superuser-access-category"}),!n&&(0,b.tZ)(m.Z,{authenticators:e,displayMode:"sudo",onTap:this.handleU2fTap})]})})}}A.displayName="SuperuserAccessForm";const v=(0,r.Z)(c.bZ,{target:"eriblrm1"})({name:"1ykowef",styles:"margin-bottom:0"}),E=(0,r.Z)("div",{target:"eriblrm0"})("width:100%;margin-left:",(0,S.D)(4),";"),Z=(0,w.Z)(A)},"./app/components/u2f/u2fContainer.tsx":(e,t,s)=>{s.d(t,{Z:()=>a});var n=s("./app/components/u2f/u2fsign.tsx"),r=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function o(e){let{className:t,authenticators:s,...o}=e;return s.length?(0,r.tZ)("div",{className:t,children:s.map((e=>"u2f"===e.id&&e.challenge?(0,r.tZ)(n.default,{...o,challengeData:e.challenge},e.id):null))}):null}o.displayName="U2fContainer";const a=o},"./app/components/u2f/u2fsign.tsx":(e,t,s)=>{s.r(t),s.d(t,{default:()=>y});var n=s("./app/locale.tsx"),r=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),o=(s("../node_modules/core-js/modules/es.error.cause.js"),s("../node_modules/react/index.js")),a=s("../node_modules/@sentry/core/esm/exports.js"),i=s("../node_modules/cbor-web/dist/cbor.js");function l(e){const t="==".slice(0,(4-e.length%4)%4),s=e.replace(/-/g,"+").replace(/_/g,"/")+t,n=atob(s),r=new ArrayBuffer(n.length),o=new Uint8Array(r);for(let e=0;e<n.length;e++)o[e]=n.charCodeAt(e);return r}function c(e){const t=new Uint8Array(e);let s="";for(const e of t)s+=String.fromCharCode(e);return btoa(s).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}s("../node_modules/core-js/modules/web.dom-exception.stack.js"),s("../node_modules/core-js/modules/es.typed-array.at.js"),s("../node_modules/core-js/modules/es.typed-array.fill.js"),s("../node_modules/core-js/modules/es.typed-array.find-last.js"),s("../node_modules/core-js/modules/es.typed-array.find-last-index.js"),s("../node_modules/core-js/modules/es.typed-array.set.js"),s("../node_modules/core-js/modules/es.typed-array.sort.js");var d=s("./app/stores/configStore.tsx"),u=s("./app/utils/withOrganization.tsx"),p=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");class h extends o.Component{constructor(){super(...arguments),(0,r.Z)(this,"state",{isSupported:null,formElement:null,challengeElement:null,hasBeenTapped:!1,deviceFailure:null,responseElement:null,isSafari:!1,failCount:0}),(0,r.Z)(this,"onTryAgain",(()=>{this.setState({hasBeenTapped:!1,deviceFailure:null},(()=>{this.invokeU2fFlow()}))})),(0,r.Z)(this,"bindChallengeElement",(e=>{this.setState({challengeElement:e,formElement:e&&e.form}),e&&(e.value=JSON.stringify(this.props.challengeData))})),(0,r.Z)(this,"bindResponseElement",(e=>this.setState({responseElement:e}))),(0,r.Z)(this,"renderSafariWebAuthn",(()=>(0,p.tZ)("a",{onClick:this.onTryAgain,className:"btn btn-primary",children:"enroll"===this.props.flowMode?(0,n.t)("Enroll with WebAuthn"):(0,n.t)("Sign in with WebAuthn")}))),(0,r.Z)(this,"renderFailure",(()=>{const{deviceFailure:e}=this.state,t=d.Z.get("supportEmail"),s=t?(0,p.tZ)("a",{href:"mailto:"+t,children:t}):(0,p.tZ)("span",{children:(0,n.t)("Support")});return this.state.isSafari&&0===this.state.failCount?this.renderSafariWebAuthn():(0,p.BX)("div",{className:"failure-message",children:[(0,p.BX)("div",{children:[(0,p.tZ)("strong",{children:(0,n.t)("Error: ")})," ",{UNKNOWN_ERROR:(0,n.t)("There was an unknown problem, please try again"),DEVICE_ERROR:(0,n.t)("Your U2F device reported an error."),DUPLICATE_DEVICE:(0,n.t)("This device is already registered with Sentry."),UNKNOWN_DEVICE:(0,n.t)("The device you used for sign-in is unknown."),BAD_APPID:(0,n._N)("[p1:The Sentry server administrator modified the device\n                 registrations.] [p2:You need to remove and re-add the device to continue using\n                 your U2F device. Use a different sign-in method or contact [support] for\n                 assistance.]",{p1:(0,p.tZ)("p",{}),p2:(0,p.tZ)("p",{}),support:s})}[e||""]]}),this.canTryAgain&&(0,p.tZ)("div",{style:{marginTop:18},children:(0,p.tZ)("a",{onClick:this.onTryAgain,className:"btn btn-primary",children:(0,n.t)("Try Again")})})]})}))}componentDidMount(){const e=!!window.PublicKeyCredential;this.setState({isSupported:e});const t=navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome");t&&this.setState({deviceFailure:"safari: requires interaction",isSafari:t,hasBeenTapped:!1}),e&&!t&&this.invokeU2fFlow()}getU2FResponse(e){if(!e.response)return JSON.stringify(e);if("sign"===this.props.flowMode){const t={keyHandle:e.id,clientData:c(e.response.clientDataJSON),signatureData:c(e.response.signature),authenticatorData:c(e.response.authenticatorData)};return JSON.stringify(t)}if("enroll"===this.props.flowMode){const t={id:e.id,rawId:c(e.rawId),response:{attestationObject:c(e.response.attestationObject),clientDataJSON:c(e.response.clientDataJSON)},type:c(e.type)};return JSON.stringify(t)}throw new Error(`Unsupported flow mode '${this.props.flowMode}'`)}submitU2fResponse(e){e.then((e=>{this.setState({hasBeenTapped:!0},(()=>{const t=this.getU2FResponse(e),s=JSON.stringify(this.props.challengeData);this.state.responseElement&&(this.state.responseElement.value=t),this.props.onTap?this.props.onTap({response:t,challenge:s}).catch((()=>{this.setState({deviceFailure:"UNKNOWN_ERROR",hasBeenTapped:!1})})):this.state.formElement?.submit()}))})).catch((e=>{let t="DEVICE_ERROR";e.metaData&&("DEVICE_INELIGIBLE"===e.metaData.type?t="enroll"===this.props.flowMode?"DUPLICATE_DEVICE":"UNKNOWN_DEVICE":"BAD_REQUEST"===e.metaData.type&&(t="BAD_APPID")),a.Tb(e),this.setState({deviceFailure:t,hasBeenTapped:!1,failCount:this.state.failCount+1})}))}webAuthnSignIn(e){const t=navigator.credentials.get({publicKey:e});this.submitU2fResponse(t)}webAuthnRegister(e){const t=navigator.credentials.create({publicKey:e});this.submitU2fResponse(t)}invokeU2fFlow(){if("sign"===this.props.flowMode){const e=l(this.props.challengeData.webAuthnAuthenticationData);i.decodeFirst(e).then((e=>{this.webAuthnSignIn(e)})).catch((e=>{a.Tb(e),this.setState({deviceFailure:"DEVICE_ERROR",hasBeenTapped:!1})}))}else{if("enroll"!==this.props.flowMode)throw new Error(`Unsupported flow mode '${this.props.flowMode}'`);{const e=l(this.props.challengeData.webAuthnRegisterData);i.decodeFirst(e).then((e=>{this.webAuthnRegister(e.publicKey)})).catch((e=>{a.Tb(e),this.setState({deviceFailure:"DEVICE_ERROR",hasBeenTapped:!1})}))}}}renderUnsupported(){return this.props.silentIfUnsupported?null:(0,p.tZ)("div",{className:"u2f-box",children:(0,p.tZ)("div",{className:"inner",children:(0,p.tZ)("p",{className:"error",children:(0,n.t)("\n             Unfortunately your browser does not support U2F. You need to use\n             a different two-factor method or switch to a browser that supports\n             it (Google Chrome or Microsoft Edge).")})})})}get canTryAgain(){return"BAD_APPID"!==this.state.deviceFailure}renderBody(){return this.state.deviceFailure?this.renderFailure():this.props.children}renderPrompt(){const{style:e}=this.props;return(0,p.BX)("div",{style:e,className:"u2f-box"+(this.state.hasBeenTapped?" tapped":"")+(this.state.deviceFailure?0===this.state.failCount&&this.state.isSafari?" loading-dots":" device-failure":""),children:[(0,p.BX)("div",{className:"device-animation-frame",children:[(0,p.tZ)("div",{className:"device-failed"}),(0,p.tZ)("div",{className:"device-animation"}),(0,p.BX)("div",{className:"loading-dots",children:[(0,p.tZ)("span",{className:"dot"}),(0,p.tZ)("span",{className:"dot"}),(0,p.tZ)("span",{className:"dot"})]})]}),(0,p.tZ)("input",{type:"hidden",name:"challenge",ref:this.bindChallengeElement}),(0,p.tZ)("input",{type:"hidden",name:"response",ref:this.bindResponseElement}),(0,p.tZ)("div",{className:"inner",children:this.renderBody()})]})}render(){const{isSupported:e}=this.state;return null===e?null:e?this.renderPrompt():this.renderUnsupported()}}h.displayName="U2fInterface";const m=(0,u.Z)(h),f={signin:(0,n.t)("Insert your U2F device or tap the button on it to confirm the sign-in request."),sudo:(0,n.t)("Alternatively you can use your U2F device to confirm the action."),enroll:(0,n.t)("To enroll your U2F device insert it now or tap the button on it to activate it.")};function g(e){let{displayMode:t="signin",...s}=e;const n="enroll"===t?"enroll":"sign";return(0,p.tZ)(m,{...s,silentIfUnsupported:"sudo"===t,flowMode:n,children:(0,p.tZ)("p",{children:f[t]??null})})}g.displayName="U2fSign";const y=g},"./app/constants/superuserAccessErrors.tsx":(e,t,s)=>{let n;s.d(t,{S:()=>n}),function(e){e.invalidPassword="Incorrect password",e.invalidSSOSession="Your SSO Session has expired, please reauthenticate",e.invalidAccessCategory="Please fill out the access category and reason correctly",e.noAuthenticator="Please add a U2F authenticator to your account",e.unknownError="An error ocurred, please try again"}(n||(n={}))}}]);
//# sourceMappingURL=../sourcemaps/SuperuserAccessForm.18ce3b5e6da0ef0c99a1c32cb7e7c868.js.map