"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["app_utils_discover_discoverQuery_tsx-app_views_starfish_components_breakdownBar_tsx"],{"./app/utils/discover/discoverQuery.tsx":(t,e,s)=>{s.d(e,{Z:()=>d,_:()=>o});var a=s("./app/utils/discover/genericDiscoverQuery.tsx"),n=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function r(t,e){return t.transactionName!==e.transactionName||t.transactionThreshold!==e.transactionThreshold||t.transactionThresholdMetric!==e.transactionThresholdMetric}function i(t){return(0,n.tZ)(a.ZP,{route:"events",shouldRefetchData:r,afterFetch:(t,e)=>{const{fields:s,...a}=t.meta??{};return{...t,meta:{...s,...a}}},...t})}function o(t){return(0,a.JC)({route:"events",shouldRefetchData:r,afterFetch:(t,e)=>{const{fields:s,...a}=t.meta??{};return{...t,meta:{...s,...a}}},...t})}i.displayName="DiscoverQuery";const d=i},"./app/views/starfish/components/breakdownBar.tsx":(t,e,s)=>{s.d(e,{c_:()=>v,An:()=>_});var a=s("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),n=(s("../node_modules/react/index.js"),s("../node_modules/react-router/es/index.js"),s("../node_modules/@emotion/is-prop-valid/dist/is-prop-valid.browser.esm.js"),s("../node_modules/@emotion/react/dist/emotion-element-6a883da9.browser.esm.js")),r=(s("../node_modules/framer-motion/dist/es/render/dom/motion.mjs"),s("../node_modules/query-string/index.js"),s("./app/components/truncate.tsx"),s("./app/locale.tsx")),i=s("./app/styles/space.tsx"),o=(s("./app/utils.tsx"),s("./app/utils/dates.tsx"),s("./app/utils/queryClient.tsx"),s("./app/utils/usePageFilters.tsx")),d=(s("./app/views/starfish/views/webServiceView/queries.js"),s("../node_modules/core-js/modules/es.array.push.js"),s("../node_modules/moment/moment.js")),m=s.n(d),l=s("./app/views/starfish/components/chart.tsx"),u=s("./app/views/starfish/components/chartPanel.tsx"),c=s("./app/views/starfish/utils/dates.tsx"),p=s("./app/views/starfish/utils/zeroFillSeries.tsx"),h=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function f(t){let{segments:e,isTopDataLoading:s,topData:a,isOtherDataLoading:i,otherData:d,cumulativeSummary:f}=t;const _=(0,o.Z)(),g=(0,n.u)(),w={},[b,y,j]=_.selection.datetime.period?.match(c.Pr)??[],D=y&&j?m()().subtract(y,j):m()(_.selection.datetime.start),E=m()(_.selection.datetime.end??void 0);!s&&!i&&e.length>0&&(e.forEach((t=>{const e=v(t.span_operation,t.action,t.domain);w[e]={seriesName:`${e}`,data:[]}})),a.forEach((t=>{w[v(t.span_operation,t.action,t.domain)].data.push({value:t.p75,name:t.interval})})),w.Other={seriesName:"Other",data:[]},d.forEach((t=>{w.Other.data.push({value:t.p75,name:t.interval})})));const O=Object.values(w).map((t=>(0,p.b)(t,m().duration(1,"day"),D,E)));return(0,h.tZ)(u.Z,{title:(0,r.t)("Duration breakdown (p50)"),children:(0,h.BX)(x,{children:[(0,h.tZ)(l.Z,{statsPeriod:"24h",height:350,data:O,start:"",end:"",loading:s,utc:!1,grid:{left:"0",right:"0",top:"16px",bottom:"8px"},definedAxisTicks:4,stacked:!0,chartColors:g.charts.getColorPalette(5)}),f]})})}f.displayName="WebServiceBreakdownChart";const x=(0,a.Z)("div",{target:"e1m9i42s0"})("display:grid;grid-auto-flow:column;grid-auto-columns:1fr min-content;align-items:center;justify-self:flex-end;gap:",(0,i.D)(2),";");function v(t,e,s){return"http.client"===t?(0,r.t)("%s requests to %s",e,s):"db"===t?(0,r.t)("%s queries on %s",e,s):t||s||void 0}function _(t,e,s){const a=v(t,e,s);return"http.client"===t?(0,r.t)("%s (http.client spans)",a):"db"===t?(0,r.t)("%s (db spans)",a):(0,r.t)("%s spans",a)}(0,i.D)(2),(0,i.D)(1),(0,i.D)(1),(0,i.D)(.5),(0,i.D)(1),(0,i.D)(1)},"./app/views/starfish/components/chart.tsx":(t,e,s)=>{s.d(e,{Z:()=>O,K:()=>N}),s("../node_modules/core-js/modules/es.array.push.js");var a=s("../node_modules/react/index.js"),n=s("../node_modules/@emotion/react/dist/emotion-element-6a883da9.browser.esm.js"),r=s("../node_modules/echarts/lib/core/echarts.js"),i=s("../node_modules/lodash/max.js"),o=s.n(i),d=s("../node_modules/lodash/min.js"),m=s.n(d),l=s("./app/components/charts/areaChart.tsx"),u=s("./app/components/charts/barChart.tsx"),c=s("./app/components/charts/baseChart.tsx"),p=s("./app/components/charts/chartZoom.tsx"),h=s("./app/components/charts/components/tooltip.tsx"),f=s("./app/components/charts/lineChart.tsx"),x=s("./app/components/charts/series/lineSeries.tsx"),v=(s("../node_modules/echarts/lib/chart/scatter.js"),s("./app/utils/theme.tsx"));function _(t){return{symbolSize:v.ZP.charts.symbolSize,...t,type:"scatter",emphasis:{...t.emphasis,scale:!0}}}var g=s("./app/utils/discover/charts.tsx"),w=s("./app/utils/discover/fields.tsx"),b=s("./app/utils/useRouter.tsx"),y=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const j="starfish_chart_group";function D(t){const e=t.map((t=>t.data.map((t=>t.value))));return o()(e.map(o()))}function E(t){let{data:e,previousData:s,statsPeriod:r,start:i,end:d,utc:v,loading:E,height:O,grid:N,disableXAxis:A,definedAxisTicks:S,chartColors:T,isBarChart:Z,isLineChart:$,stacked:R,log:C,hideYAxisSplitLine:P,showLegend:q,scatterPlot:L,throughput:B,aggregateOutputFormat:M,onClick:k,forwardedRef:I,chartGroup:F,tooltipFormatterOptions:Y={}}=t;const W=(0,b.Z)(),H=(0,n.u)(),G=(0,a.useRef)(null),X=I||G,z=X?.current?.getEchartsInstance();if(z&&!z.group&&(z.group=F??j),!e||e.length<=0)return null;const U=T??H.charts.getColorPalette(4),Q="duration"===M||e.every((t=>"duration"===(0,w.Px)(t.seriesName))),V="percentage"===M||e.every((t=>"percentage"===(0,w.Px)(t.seriesName)));let J=Q?function(t){let e=0;if(t.length>2)for(let s=0;s<t.length;s++)e+=o()(t[s].data.map((t=>t.value)));else e=D(t);if(e<=1)return 1;const s=Math.log10(e),a=m()([o()([10**(s-Math.floor(s)),0]),10]);let n;n=a<=2.5?.2:a<=5?.5:a<=7.5?1:2;const r=10**Math.floor(s)*n;return Math.round(Math.ceil(e/r)*r)}([...e,...L?.[0]?.data?.length?L:[]]):V?D(e):void 0;1===J&&Q&&(J+=1);const K=(0,g.Xp)(e);let tt;const et=[];B&&B.length>1&&(tt=[(0,x.Z)({name:"Throughput",data:B.map((t=>{let{interval:e,count:s}=t;return[e,s]})),yAxisIndex:1,lineStyle:{type:"dashed",width:1,opacity:.5},animation:!1,animationThreshold:1,animationDuration:0})],et.push({minInterval:K,splitNumber:S,max:J,type:"value",axisLabel:{color:H.chartLabel,formatter:t=>(0,g.gu)(t,"number",!0)},splitLine:P?{show:!1}:void 0}));const st=[{minInterval:K,splitNumber:S,max:J,type:C?"log":"value",axisLabel:{color:H.chartLabel,formatter:t=>(0,g.gu)(t,M??(0,w.Px)(e[0].seriesName),void 0,K)},splitLine:P?{show:!1}:void 0},...et],at={seriesOptions:{showSymbol:!1},grid:N,yAxes:st,utc:v,legend:q?{top:0,right:10}:void 0,isGroupedByDate:!0,showTimeInTooltip:!0,tooltip:{formatter:(t,e)=>Array.from(document.querySelectorAll(":hover")).find((t=>t.classList.contains("echarts-for-react")))===X?.current?.ele?(0,h.Pf)({isGroupedByDate:!0,showTimeInTooltip:!0,utc:v,...Y})(t,e):"",trigger:"axis",axisPointer:{type:"cross",label:{show:!1}},valueFormatter:(t,s)=>(0,g.CX)(t,M??(0,w.Px)(e&&e.length?e[0].seriesName:s)),nameFormatter:t=>"epm()"===t?"tpm()":t}};if(E)return $?(0,y.tZ)(f.w,{height:O,series:[],...at}):Z?(0,y.tZ)(u.v,{height:O,series:[],...at}):(0,y.tZ)(l.T,{height:O,series:[],...at});const nt=e.map(((t,e)=>({...t,yAxisIndex:0,xAxisIndex:0}))),rt=A?{show:!1,axisLabel:{show:!0,margin:0},axisLine:{show:!1}}:void 0;return(0,y.tZ)(p.Z,{router:W,period:r,start:i,end:d,utc:v,children:t=>$?(0,y.tZ)(c.Z,{...t,ref:X,height:O,previousPeriod:s,additionalSeries:tt,xAxis:rt,yAxes:at.yAxes,tooltip:at.tooltip,colors:U,grid:N,legend:q?{top:0,right:0}:void 0,onClick:k,series:[...nt.map((t=>{let{seriesName:e,data:s,...a}=t;return(0,x.Z)({...a,name:e,data:s?.map((t=>{let{value:e,name:s}=t;return[s,e]})),animation:!1,animationThreshold:1,animationDuration:0})})),...(L??[]).map((t=>{let{seriesName:e,data:s,...a}=t;return _({...a,name:e,data:s?.map((t=>{let{value:e,name:s}=t;return[s,e]})),animation:!1})}))]}):Z?(0,y.tZ)(u.v,{height:O,series:nt,xAxis:rt,additionalSeries:tt,yAxes:at.yAxes,tooltip:at.tooltip,colors:U,grid:N,legend:q?{top:0,right:0}:void 0}):(0,y.tZ)(l.T,{forwardedRef:X,height:O,...t,series:nt,previousPeriod:s,additionalSeries:tt,xAxis:rt,stacked:R,...at})})}E.displayName="Chart";const O=E;function N(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const[e,s]=(0,a.useState)(!1);(0,a.useEffect)((()=>{t.every(Boolean)&&(r.$j(j),s(!0))}),[t,e])}},"./app/views/starfish/components/chartPanel.tsx":(t,e,s)=>{s.d(e,{Z:()=>o});var a=s("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),n=(s("../node_modules/react/index.js"),s("./app/components/panels/index.tsx")),r=s("./app/styles/space.tsx"),i=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function o(t){let{title:e,children:s,button:a}=t;return(0,i.tZ)(n.s_,{children:(0,i.BX)(n.N,{withPadding:!0,children:[(0,i.BX)(m,{children:[e&&(0,i.tZ)(d,{children:e}),a]}),s]})})}o.displayName="ChartPanel";const d=(0,a.Z)("p",{target:"e1tvnfsq1"})((t=>t.theme.text.cardTitle),";"),m=(0,a.Z)("div",{target:"e1tvnfsq0"})("padding:0 ",(0,r.D)(1)," 0 0;min-height:36px;width:100%;display:flex;align-items:center;justify-content:space-between;")},"./app/views/starfish/utils/dates.tsx":(t,e,s)=>{s.d(e,{Pr:()=>d,SW:()=>l,ie:()=>o,tZ:()=>u}),s("../node_modules/core-js/modules/es.error.cause.js");var a=s("../node_modules/moment/moment.js"),n=s.n(a),r=s("./app/utils/dates.tsx");function i(t,e){const s=n()(e).diff(n()(t)),a=n()(t).add(s/2);return(0,r.v5)(a)}function o(t){let{start:e,end:s,statsPeriod:a}=t;if(a)return i((0,r.Yz)("hours",(0,r.YJ)(a)).toDate(),new Date);if(!e||!s)throw new Error("start and end required");return i(e,s)}const d=/^(\d+)([h,d])$/,m="YYYY-MM-DD HH:mm:ss",l=t=>{if(!t)return{};const[e,s,a]=t.period?.match(d)??[];return{start_timestamp:(t.start&&n()(t.start).format(m))??(s&&a&&n()().subtract(s,a).startOf("minute").format(m)),end_timestamp:t.end&&n()(t.end).format(m)}};function u(t){const[e,s,a]=t.selection.datetime.period?.match(d)??[];return{startTime:s&&a?n()().subtract(s,a):n()(t.selection.datetime.start),endTime:n()(t.selection.datetime.end??void 0)}}},"./app/views/starfish/utils/zeroFillSeries.tsx":(t,e,s)=>{s.d(e,{b:()=>r}),s("../node_modules/core-js/modules/es.array.push.js");var a=s("../node_modules/moment/moment.js"),n=s.n(a);function r(t,e,s,a,r){if(!t?.data?.length)return t;r||(r=0);const o=t.data[0],d=t.data[t.data.length-1],m=n()(o.name).creationData().format?.toString();if(!m)return t;const l=[],u=s&&i(s),c=a&&i(a),p=[...u&&u.diff(n()(o.name))<0?[{value:r,name:u.format(m)}]:[],...t.data,...c&&c.diff(n()(d.name))>0?[{value:r,name:c.format(m)}]:[]];let h,f,x,v,_;for(let t=0;t<p.length-1;t++){for(0===t&&l.push({...p[t],name:n()(p[t].name).format(m)}),h=p[t],f=p[t+1],x=n()(h.name),v=n()(f.name),_=n().duration(v.diff(x));_.asMilliseconds()>e.asMilliseconds();)x.add(e),l.push({value:r,name:n()(x).format(m)}),_=n().duration(n()(f.name).diff(x));l.push({...f,name:n()(f.name).format(m)})}return{...t,data:l}}function i(t){const e=t.hour(),s=t.clone().startOf("day");return e<12?s:s.add(12,"hour")}},"./app/views/starfish/views/webServiceView/queries.js":(t,e,s)=>{s.d(e,{Lb:()=>r,Sy:()=>i,hj:()=>o,u4:()=>n});var a=s("./app/views/starfish/utils/dates.tsx");const n=t=>{let{transaction:e,datetime:s}=t;const{start_timestamp:n,end_timestamp:r}=(0,a.SW)(s);return`SELECT domain, action, span_operation, module, sum(exclusive_time) as sum, uniq(description) as num_spans\n   FROM spans_experimental_starfish\n   WHERE span_operation NOT IN ['base.dispatch.execute', 'middleware.django', 'base.dispatch.request']\n   ${e?`AND transaction = '${e}'`:""}\n   ${n?`AND greaterOrEquals(start_timestamp, '${n}')`:""}\n   ${r?`AND lessOrEquals(start_timestamp, '${r}')`:""}\n   GROUP BY domain, action, span_operation, module\n   ORDER BY -sum(exclusive_time)\n   LIMIT 5\n `},r=t=>{let{transaction:e,topConditions:s,datetime:n}=t;const{start_timestamp:r,end_timestamp:i}=(0,a.SW)(n);return`SELECT\n quantile(0.50)(exclusive_time) as p50, domain, action, span_operation, module,\n toStartOfInterval(start_timestamp, INTERVAL 12 HOUR) as interval\n FROM default.spans_experimental_starfish\n WHERE greaterOrEquals(start_timestamp, '${r}')\n ${i?`AND lessOrEquals(start_timestamp, '${i}')`:""}\n ${s?`AND (${s})`:""}\n ${e?`AND transaction = '${e}'`:""}\n GROUP BY interval, domain, action, span_operation, module\n ORDER BY interval, domain, action, span_operation, module\n `},i=t=>{let{transaction:e,topConditions:s,datetime:n}=t;const{start_timestamp:r,end_timestamp:i}=(0,a.SW)(n);return`SELECT\n quantile(0.50)(exclusive_time) as p50,\n toStartOfInterval(start_timestamp, INTERVAL 12 HOUR) as interval\n FROM default.spans_experimental_starfish\n WHERE greaterOrEquals(start_timestamp, '${r}')\n ${i?`AND lessOrEquals(start_timestamp, '${i}')`:""}\n ${s?`AND NOT (${s})`:""}\n ${e?`AND transaction = '${e}'`:""}\n GROUP BY interval\n ORDER BY interval\n `},o=t=>{let{transaction:e,datetime:s}=t;const{start_timestamp:n,end_timestamp:r}=(0,a.SW)(s);return`SELECT sum(exclusive_time) as sum\n   FROM spans_experimental_starfish\n   WHERE greaterOrEquals(start_timestamp, '${n}')\n   ${r?`AND lessOrEquals(start_timestamp, '${r}')`:""}\n   ${e?`AND transaction = '${e}'`:""}\n `}}}]);
//# sourceMappingURL=../sourcemaps/app_utils_discover_discoverQuery_tsx-app_views_starfish_components_breakdownBar_tsx.f0814a48ef2fbccaf9372fd56664e56e.js.map