{"version":3,"file":"chunks/app_views_discover_homepage_tsx.xxxxxxxxxxxxxxxxxxxx.js","mappings":"m3BAmCA,MAAMA,UAAyBC,EAAAA,EAA0CC,cAAA,SAAAC,YAAAC,EAAAA,EAAAA,GAAA,qBACxD,IAAIA,EAAAA,EAAAA,GAAA,sBAgFFC,IACfC,KAAKC,SAAS,CAACC,WAAYH,GAAe,GAC3C,CAhFDI,mBAAmBC,EAAGC,GACpB,MAAMC,GAAwBD,EAAUH,YAAcF,KAAKO,MAAML,WAC3DM,EAAqBH,EAAUI,UAAYT,KAAKO,MAAME,QACtDC,EAAiBV,KAAKO,MAAML,YAA6C,KAA/BF,KAAKW,MAAMC,SAASC,OAC9DC,EAAyBC,EAAAA,GAAAA,aAAuBf,KAAKW,MAAMC,UAAUI,UAE3E,GACEhB,KAAKO,MAAML,aACTM,GAAsBF,IAAyBQ,GAC/CJ,GACF,CACA,MAAMO,EAAYF,EAAAA,GAAAA,eAAyBf,KAAKO,MAAML,YAChDgB,GAAkBC,EAAAA,EAAAA,IAAqBnB,KAAKW,MAAMS,aAAaC,MACrE,IAAIC,EAAQ,IACPL,EAAUM,6BAMXL,GAAiBM,eACnBN,EAAgBM,cAAcC,SAAQC,IACpC,GAAqB,aAAjBA,EACFJ,EAAMK,QAAUT,EAAgBX,MAAMoB,SAASC,IAAIC,aAC9C,GAAqB,aAAjBH,EAA6B,CACtC,MAAM,OAACI,EAAM,MAAEC,EAAK,IAAEC,EAAG,IAAEC,IAAOC,EAAAA,EAAAA,IAAqBhB,EAAgBX,OACvEe,EAAQ,IACHA,EACHa,YAAaL,QAAUM,EACvBH,IAAKA,GAAKI,WACVN,OAAOO,EAAAA,EAAAA,IAAwBP,GAC/BC,KAAKM,EAAAA,EAAAA,IAAwBN,GAEjC,MACEV,EAAMI,GAAgBR,EAAgBX,MAAMmB,EAC9C,IAIJa,EAAAA,eAAAA,QAAuB,IAClBvC,KAAKW,MAAMC,SACdU,SAEJ,CACF,CAEAkB,eACE,MAAM,aAACpB,EAAY,UAAEqB,GAAazC,KAAKW,OACjC,SAAC+B,EAAQ,aAAEC,EAAY,SAAEC,GAAYH,EACrCI,EAAc,CAClBC,YAAaH,EACbhB,QAASe,EAASd,KAAImB,GAAQlB,OAAOkB,MAGjCC,EAAwD,GAc9D,OAbI5B,EAAa6B,SAASC,SAAS,mBACjCF,EAAUG,KAAK,CACb,aACC,kBAAiB/B,EAAaC,4BAG/BD,EAAa6B,SAASC,SAAS,2BACjCF,EAAUG,KAAK,CACb,iBACC,kBAAiB/B,EAAaC,wBAC/B,CAACC,MAAO,IAAIuB,MAAgBO,EAAAA,EAAAA,IAAwBR,OAGjDI,CACT,CAEAK,iBAAgBC,GAAmB,IAAlB,SAACC,EAAQ,KAAEC,GAAKF,EAEd,eAAbC,GAAsC,KAATC,GAC/BxD,KAAKC,SAAS,CAACC,WAAY,MAE/B,CAMAuD,aACE,MAAM,WAACvD,EAAU,QAAEO,GAAWT,KAAKO,MACnC,OACEmD,EAAAA,EAAAA,IAACC,EAAAA,QAAO,IACF3D,KAAKW,MACTT,WAAYA,QAAckC,EAC1B3B,QAASA,EACTmD,cAAe5D,KAAK4D,cACpBC,YAAU,GAGhB,EAGF,SAASC,EAAkBnD,GACzB,OACE+C,EAAAA,EAAAA,IAACK,EAAAA,EAAoB,CAACC,yBAAuB,EAAAC,UAC3CP,EAAAA,EAAAA,IAAChE,EAAgB,IAAKiB,KAG5B,CANSmD,EAAiBI,YAAA,oBAQ1B,SAAeC,EAAAA,EAAAA,IAAQC,EAAAA,EAAAA,IAAiBC,EAAAA,EAAAA,GAAgBP,I","sources":["webpack:///./app/views/discover/homepage.tsx"],"sourcesContent":["import {browserHistory, InjectedRouter} from 'react-router';\nimport {Location} from 'history';\n\nimport {Client} from 'sentry/api';\nimport AsyncComponent from 'sentry/components/asyncComponent';\nimport PageFiltersContainer from 'sentry/components/organizations/pageFilters/container';\nimport {\n  getDatetimeFromState,\n  normalizeDateTimeParams,\n  normalizeDateTimeString,\n} from 'sentry/components/organizations/pageFilters/parse';\nimport {getPageFilterStorage} from 'sentry/components/organizations/pageFilters/persistence';\nimport {Organization, PageFilters, SavedQuery} from 'sentry/types';\nimport EventView from 'sentry/utils/discover/eventView';\nimport withApi from 'sentry/utils/withApi';\nimport withOrganization from 'sentry/utils/withOrganization';\nimport withPageFilters from 'sentry/utils/withPageFilters';\n\nimport {Results} from './results';\n\ntype Props = {\n  api: Client;\n  loading: boolean;\n  location: Location;\n  organization: Organization;\n  router: InjectedRouter;\n  selection: PageFilters;\n  setSavedQuery: (savedQuery: SavedQuery) => void;\n};\n\ntype HomepageQueryState = AsyncComponent['state'] & {\n  savedQuery?: SavedQuery | null;\n  starfishResult?: null;\n};\n\nclass HomepageQueryAPI extends AsyncComponent<Props, HomepageQueryState> {\n  shouldReload = true;\n\n  componentDidUpdate(_, prevState) {\n    const hasFetchedSavedQuery = !prevState.savedQuery && this.state.savedQuery;\n    const hasInitiallyLoaded = prevState.loading && !this.state.loading;\n    const sidebarClicked = this.state.savedQuery && this.props.location.search === '';\n    const hasValidEventViewInURL = EventView.fromLocation(this.props.location).isValid();\n\n    if (\n      this.state.savedQuery &&\n      ((hasInitiallyLoaded && hasFetchedSavedQuery && !hasValidEventViewInURL) ||\n        sidebarClicked)\n    ) {\n      const eventView = EventView.fromSavedQuery(this.state.savedQuery);\n      const pageFilterState = getPageFilterStorage(this.props.organization.slug);\n      let query = {\n        ...eventView.generateQueryStringObject(),\n      };\n\n      // Handle locked filters explicitly because we can't expect\n      // PageFilterContainer to properly overwrite stored filters\n      // when pushing the homepage query to the URL\n      if (pageFilterState?.pinnedFilters) {\n        pageFilterState.pinnedFilters.forEach(pinnedFilter => {\n          if (pinnedFilter === 'projects') {\n            query.project = pageFilterState.state.project?.map(String);\n          } else if (pinnedFilter === 'datetime') {\n            const {period, start, end, utc} = getDatetimeFromState(pageFilterState.state);\n            query = {\n              ...query,\n              statsPeriod: period ?? undefined,\n              utc: utc?.toString(),\n              start: normalizeDateTimeString(start),\n              end: normalizeDateTimeString(end),\n            };\n          } else {\n            query[pinnedFilter] = pageFilterState.state[pinnedFilter];\n          }\n        });\n      }\n\n      browserHistory.replace({\n        ...this.props.location,\n        query,\n      });\n    }\n  }\n\n  getEndpoints(): ReturnType<AsyncComponent['getEndpoints']> {\n    const {organization, selection} = this.props;\n    const {projects, environments, datetime} = selection;\n    const commonQuery = {\n      environment: environments,\n      project: projects.map(proj => String(proj)),\n    };\n\n    const endpoints: ReturnType<AsyncComponent['getEndpoints']> = [];\n    if (organization.features.includes('discover-query')) {\n      endpoints.push([\n        'savedQuery',\n        `/organizations/${organization.slug}/discover/homepage/`,\n      ]);\n    }\n    if (organization.features.includes('starfish-test-endpoint')) {\n      endpoints.push([\n        'starfishResult',\n        `/organizations/${organization.slug}/events-starfish/`,\n        {query: {...commonQuery, ...normalizeDateTimeParams(datetime)}},\n      ]);\n    }\n    return endpoints;\n  }\n\n  onRequestSuccess({stateKey, data}) {\n    // No homepage query results in a 204, returning an empty string\n    if (stateKey === 'savedQuery' && data === '') {\n      this.setState({savedQuery: null});\n    }\n  }\n\n  setSavedQuery = (newSavedQuery?: SavedQuery) => {\n    this.setState({savedQuery: newSavedQuery});\n  };\n\n  renderBody(): React.ReactNode {\n    const {savedQuery, loading} = this.state;\n    return (\n      <Results\n        {...this.props}\n        savedQuery={savedQuery ?? undefined}\n        loading={loading}\n        setSavedQuery={this.setSavedQuery}\n        isHomepage\n      />\n    );\n  }\n}\n\nfunction HomepageContainer(props: Props) {\n  return (\n    <PageFiltersContainer skipInitializeUrlParams>\n      <HomepageQueryAPI {...props} />\n    </PageFiltersContainer>\n  );\n}\n\nexport default withApi(withOrganization(withPageFilters(HomepageContainer)));\n"],"names":["HomepageQueryAPI","AsyncComponent","constructor","arguments","_defineProperty","newSavedQuery","this","setState","savedQuery","componentDidUpdate","_","prevState","hasFetchedSavedQuery","state","hasInitiallyLoaded","loading","sidebarClicked","props","location","search","hasValidEventViewInURL","EventView","isValid","eventView","pageFilterState","getPageFilterStorage","organization","slug","query","generateQueryStringObject","pinnedFilters","forEach","pinnedFilter","project","map","String","period","start","end","utc","getDatetimeFromState","statsPeriod","undefined","toString","normalizeDateTimeString","browserHistory","getEndpoints","selection","projects","environments","datetime","commonQuery","environment","proj","endpoints","features","includes","push","normalizeDateTimeParams","onRequestSuccess","_ref","stateKey","data","renderBody","_jsx","Results","setSavedQuery","isHomepage","HomepageContainer","PageFiltersContainer","skipInitializeUrlParams","children","displayName","withApi","withOrganization","withPageFilters"],"sourceRoot":""}