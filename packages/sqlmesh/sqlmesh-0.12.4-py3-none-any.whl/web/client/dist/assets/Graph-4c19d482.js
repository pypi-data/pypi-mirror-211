import{r as n,j as e,g as y,z as te,am as ne,L as le,S as ae,v as oe,at as re,d as V,b as q,H as ie,I as ce,i as K,c as $,V as ue,Y as de}from"./index-3144ef62.js";import{a as me,b as Y,c as he,P as fe,d as F,s as Z,e as ge,H as D,t as z,f as A,h as pe,u as P,m as xe,g as ve,i as ye,j as be,R as we,k as je,l as Ce}from"./context-a28ba8eb.js";import{I as Ne}from"./Input-81dfa79c.js";function ke({title:t,titleId:s,...l},i){return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:i,"aria-labelledby":s},l),t?n.createElement("title",{id:s},t):null,n.createElement("path",{fillRule:"evenodd",d:"M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm4.28 10.28a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H8.25a.75.75 0 000 1.5h5.69l-1.72 1.72a.75.75 0 101.06 1.06l3-3z",clipRule:"evenodd"}))}const Me=n.forwardRef(ke),Se=Me;function Ee(){return e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",children:e.jsx("path",{d:"M32 18.133H18.133V32h-4.266V18.133H0v-4.266h13.867V0h4.266v13.867H32z"})})}function ze(){return e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 5",children:e.jsx("path",{d:"M0 0h32v4.2H0z"})})}function He(){return e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 30",children:e.jsx("path",{d:"M3.692 4.63c0-.53.4-.938.939-.938h5.215V0H4.708C2.13 0 0 2.054 0 4.63v5.216h3.692V4.631zM27.354 0h-5.2v3.692h5.17c.53 0 .984.4.984.939v5.215H32V4.631A4.624 4.624 0 0027.354 0zm.954 24.83c0 .532-.4.94-.939.94h-5.215v3.768h5.215c2.577 0 4.631-2.13 4.631-4.707v-5.139h-3.692v5.139zm-23.677.94c-.531 0-.939-.4-.939-.94v-5.138H0v5.139c0 2.577 2.13 4.707 4.708 4.707h5.138V25.77H4.631z"})})}function Le(){return e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32",children:e.jsx("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0 8 0 4.571 3.429 4.571 7.619v3.048H3.048A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047zm4.724-13.866H7.467V7.619c0-2.59 2.133-4.724 4.723-4.724 2.591 0 4.724 2.133 4.724 4.724v3.048z"})})}function Ae(){return e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32",children:e.jsx("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0c-4.114 1.828-1.37 2.133.305 2.438 1.676.305 4.42 2.59 4.42 5.181v3.048H3.047A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047z"})})}const _=({children:t,className:s,...l})=>e.jsx("button",{type:"button",className:F(["react-flow__controls-button",s]),...l,children:t});_.displayName="ControlButton";const Re=t=>({isInteractive:t.nodesDraggable||t.nodesConnectable||t.elementsSelectable,minZoomReached:t.transform[2]<=t.minZoom,maxZoomReached:t.transform[2]>=t.maxZoom}),X=({style:t,showZoom:s=!0,showFitView:l=!0,showInteractive:i=!0,fitViewOptions:m,onZoomIn:r,onZoomOut:a,onFitView:h,onInteractiveChange:u,className:v,children:p,position:j="bottom-left"})=>{const N=me(),[k,b]=n.useState(!1),{isInteractive:w,minZoomReached:M,maxZoomReached:o}=Y(Re,Z),{zoomIn:f,zoomOut:c,fitView:C}=he();if(n.useEffect(()=>{b(!0)},[]),!k)return null;const L=()=>{f(),r==null||r()},E=()=>{c(),a==null||a()},H=()=>{C(m),h==null||h()},B=()=>{N.setState({nodesDraggable:!w,nodesConnectable:!w,elementsSelectable:!w}),u==null||u(!w)};return e.jsxs(fe,{className:F(["react-flow__controls",v]),position:j,style:t,"data-testid":"rf__controls",children:[s&&e.jsxs(e.Fragment,{children:[e.jsx(_,{onClick:L,className:"react-flow__controls-zoomin",title:"zoom in","aria-label":"zoom in",disabled:o,children:e.jsx(Ee,{})}),e.jsx(_,{onClick:E,className:"react-flow__controls-zoomout",title:"zoom out","aria-label":"zoom out",disabled:M,children:e.jsx(ze,{})})]}),l&&e.jsx(_,{className:"react-flow__controls-fitview",onClick:H,title:"fit view","aria-label":"fit view",children:e.jsx(He,{})}),i&&e.jsx(_,{className:"react-flow__controls-interactive",onClick:B,title:"toggle interactivity","aria-label":"toggle interactivity",children:w?e.jsx(Ae,{}):e.jsx(Le,{})}),p]})};X.displayName="Controls";var _e=n.memo(X),S;(function(t){t.Lines="lines",t.Dots="dots",t.Cross="cross"})(S||(S={}));function Ve({color:t,dimensions:s,lineWidth:l}){return e.jsx("path",{stroke:t,strokeWidth:l,d:`M${s[0]/2} 0 V${s[1]} M0 ${s[1]/2} H${s[0]}`})}function Be({color:t,radius:s}){return e.jsx("circle",{cx:s,cy:s,r:s,fill:t})}const $e={[S.Dots]:"#91919a",[S.Lines]:"#eee",[S.Cross]:"#e2e2e2"},De={[S.Dots]:1,[S.Lines]:1,[S.Cross]:6},Fe=t=>({transform:t.transform,patternId:`pattern-${t.rfId}`});function J({id:t,variant:s=S.Dots,gap:l=20,size:i,lineWidth:m=1,offset:r=2,color:a,style:h,className:u}){const v=n.useRef(null),{transform:p,patternId:j}=Y(Fe,Z),N=a||$e[s],k=i||De[s],b=s===S.Dots,w=s===S.Cross,M=Array.isArray(l)?l:[l,l],o=[M[0]*p[2]||1,M[1]*p[2]||1],f=k*p[2],c=w?[f,f]:o,C=b?[f/r,f/r]:[c[0]/r,c[1]/r];return e.jsxs("svg",{className:F(["react-flow__background",u]),style:{...h,position:"absolute",width:"100%",height:"100%",top:0,left:0},ref:v,"data-testid":"rf__background",children:[e.jsx("pattern",{id:j+t,x:p[0]%o[0],y:p[1]%o[1],width:o[0],height:o[1],patternUnits:"userSpaceOnUse",patternTransform:`translate(-${C[0]},-${C[1]})`,children:b?e.jsx(Be,{color:N,radius:f/r}):e.jsx(Ve,{dimensions:c,color:N,lineWidth:m})}),e.jsx("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:`url(#${j+t})`})]})}J.displayName="Background";var Pe=n.memo(J);const Q=n.memo(function({columnName:s,columnType:l,columnDescription:i,className:m}){return e.jsxs("div",{className:y("w-full items-center",m),children:[e.jsxs("div",{className:"w-full flex justify-between items-center",children:[e.jsx("span",{children:s}),e.jsx("span",{className:"inline-block text-neutral-400 dark:text-neutral-300 ml-4",children:l})]}),i!=null&&e.jsx("p",{className:"text-neutral-600 dark:text-neutral-400 mt-1",children:i})]})}),Te=n.memo(function({nodeId:s,id:l,hasLeft:i=!1,hasRight:m=!1,disabled:r=!1,children:a,className:h}){const u=ge();return n.useEffect(()=>{setTimeout(()=>{u(s)},100)},[i,m]),e.jsxs("div",{className:y("flex w-full !relative px-3 py-1 items-center",K(r)&&"hover:bg-secondary-10 dark:hover:bg-primary-10",h),children:[m&&e.jsx(D,{type:"target",id:z("right",l),position:A.Right,isConnectable:!1,className:y("w-2 h-2 rounded-full !bg-secondary-500 dark:!bg-primary-500")}),a,i&&e.jsx(D,{type:"source",id:z("left",l),position:A.Left,isConnectable:!1,className:y("w-2 h-2 rounded-full !bg-secondary-500 dark:!bg-primary-500")})]})}),Ie=n.memo(function({id:s,className:l,hasLeft:i=!1,hasRight:m=!1,label:r,type:a,handleClick:h}){return e.jsxs("div",{className:y("flex w-full !relative px-3 py-1 items-center",l),children:[m&&e.jsx(D,{type:"target",id:z("right",s),position:A.Right,isConnectable:!1,className:y("w-2 h-2 rounded-full !bg-secondary-500 dark:!bg-primary-500")}),e.jsxs("span",{className:"inline-block w-full",children:[a!=null&&e.jsxs("span",{title:a==="python"?"Column lineage disabled for Python models":"SQL Model",className:"inline-block mr-2 bg-primary-30 px-2 rounded-[0.25rem] text-[0.5rem]",children:[a==="python"&&"Python",a==="sql"&&"SQL",a==="seed"&&"Seed"]}),e.jsx("span",{className:y("inline-block",h!=null&&"cursor-pointer hover:underline"),onClick:h,children:r})]}),i&&e.jsx(D,{type:"source",id:z("left",s),position:A.Left,isConnectable:!1,className:y("!bg-transparent -ml-2 dark:text-primary-500"),children:e.jsx(Se,{className:"w-5 bg-theme rounded-full"})})]})}),W=n.memo(function({id:s,nodeId:l,column:i,className:m,disabled:r=!1,isActive:a=!1,hasLeft:h=!1,hasRight:u=!1,getColumnLineage:v,handleError:p,updateColumnLineage:j,removeEdges:N,selectManually:k,withHandles:b=!1}){const w=n.useCallback(te(v,1e3,!0),[v]),[M,o]=n.useState(!1),[f,c]=n.useState(!1),[C,L]=n.useState(!1);n.useEffect(()=>{k!=null&&(E(),k(void 0))},[k]);function E(){r||(a?N(s):(o(!0),c(!1),L(!1),w(i.name).then(H=>{L(pe()),j(H)}).catch(H=>{c(!0),p==null||p(H)}).finally(()=>{o(!1)})))}return e.jsx("div",{className:y(a&&"bg-secondary-10 dark:bg-primary-900",b?"p-0":"py-1 px-2 rounded-md mb-1",m),onClick:ne(E,500),children:e.jsxs("div",{className:y("flex w-full items-center",r?"opacity-50 cursor-not-allowed":"cursor-pointer",m),children:[M&&e.jsx(le,{className:"inline-block mr-2",children:e.jsx(ae,{className:"w-3 h-3 border border-neutral-10"})}),b?e.jsx(Te,{id:s,nodeId:l,hasLeft:h,hasRight:u,disabled:r,children:e.jsx(Q,{columnName:i.name,columnType:i.type,disabled:r,className:y(f&&"text-danger-500",C&&"text-neutral-400 dark:text-neutral-600")})}):e.jsx(Q,{columnName:i.name,columnType:i.type,disabled:r,className:y(f&&"text-danger-500",C&&"text-neutral-400 dark:text-neutral-600")})]})})}),Oe=n.memo(function({nodeId:s,columns:l,disabled:i,className:m,limit:r=5,withHandles:a=!1}){const h=oe(),{connections:u,isActiveColumn:v,setConnections:p,manuallySelectedColumn:j,setManuallySelectedColumn:N,handleError:k,setLineage:b,removeActiveEdges:w,hasActiveEdge:M,addActiveEdges:o}=P(),[f,c]=n.useState(""),[C,L]=n.useState(l.length<=r),[E=[],H=[]]=n.useMemo(()=>{const d=[],g=[];return l.forEach(x=>{v(s,x.name)?d.push(x):(C||d.length+g.length<r)&&g.push(x)}),[d,g]},[s,l,C,v,M]),B=n.useCallback(async function(g){return await h.fetchQuery({queryKey:["/api/lineage",s,g],queryFn:async({signal:x})=>await re(s,g,{signal:x}),cacheTime:0})},[s]),T=n.useCallback(function(g={}){b(x=>xe(structuredClone(x),g)),p(x=>ve(g,x,o))},[o,p]),I=n.useCallback(function(g){if(j==null)return!1;const[x,R]=j;return x==null||R==null?!1:x.name===s&&R.name===g},[s,j]),O=n.useCallback(function(g){w([g,x(g,"left"),x(g,"right")].flat());function x(R,G){var U;const ee=((U=u.get(R))==null?void 0:U[G])??[];return[R,ee.map(se=>x(se,G))].flat(1/0)}},[w,u]);return e.jsxs(e.Fragment,{children:[V(E)&&e.jsx("div",{className:y("overflow-hidden overflow-y-auto scrollbar scrollbar--vertical-md",a?"w-full bg-theme-lighter cursor-default":"",m),children:E.map(d=>{var g,x;return e.jsx(W,{id:z(s,d.name),nodeId:s,column:d,disabled:i,handleError:k,getColumnLineage:B,updateColumnLineage:T,removeEdges:O,isActive:!0,hasLeft:V((g=u.get(z(s,d.name)))==null?void 0:g.left),hasRight:V((x=u.get(z(s,d.name)))==null?void 0:x.right),selectManually:I(d.name)?N:void 0,withHandles:a},z(s,d.name))})}),H.length>20&&e.jsx("div",{className:"p-1 w-full flex justify-between bg-theme",children:e.jsx(Ne,{className:"w-full !m-0",size:q.sm,value:f,placeholder:"Filter models",onInput:d=>{c(d.target.value)}})}),e.jsx("div",{className:y("overflow-hidden overflow-y-auto scrollbar scrollbar--vertical-md py-2",a?"w-full bg-theme-lighter cursor-default":"",m),children:H.map(d=>e.jsx(W,{id:z(s,d.name),nodeId:s,column:d,disabled:i,handleError:k,getColumnLineage:B,updateColumnLineage:T,removeEdges:O,isActive:!1,hasLeft:!1,hasRight:!1,selectManually:I(d.name)?N:void 0,className:y(f===""||(!C||d.name.includes(f))?"opacity-100":"opacity-0 h-0 overflow-hidden"),withHandles:a},z(s,d.name)))}),l.length>r&&e.jsx("div",{className:"py-2 flex justify-center bg-theme-lighter",children:e.jsx(ie,{size:q.xs,variant:ce.Neutral,onClick:d=>{d.stopPropagation(),L(g=>!g)},children:C?"Hide":`Show ${l.length-E.length-H.length} More`})})]})});function We({model:t,highlightedNodes:s,className:l}){const{withColumns:i,hasActiveEdge:m,models:r,lineage:a}=P(),[h,u]=n.useState([]),[v,p]=n.useState([]),[j,N]=n.useState(!0),k=n.useMemo(()=>({model:Ge}),[]),b=n.useCallback(function(f=[]){return f.map(c=>(c.sourceHandle==null&&c.targetHandle==null?c.hidden=!1:c.hidden=K(m(c.sourceHandle)&&m(c.targetHandle)),c))},[m]);n.useEffect(()=>{N($(h)||$(v));const o={"border-4 border-brand-500":[t.name]},f=ye({lineage:a,highlightedNodes:s??o,models:r,nodes:h,edges:v,model:t,withColumns:i});be(f).then(c=>{u(c.nodes),p(b(c.edges)),N($(c.nodes)||$(c.edges))})},[t.name,r,s,a]),n.useEffect(()=>{p(b(v))},[b]);function w(o){u(je(o,h))}function M(o){p(Ce(o,v))}return e.jsx("div",{className:y("px-2 py-1 w-full h-full",l),children:j?e.jsx("div",{children:"Building Lineage..."}):e.jsxs(we,{nodes:h,edges:v,nodeTypes:k,onNodesChange:w,onEdgesChange:M,nodeOrigin:[.5,.5],minZoom:.1,maxZoom:1.5,fitView:!0,children:[e.jsx(_e,{className:"bg-light p-1 rounded-md !border-none !shadow-lg"}),e.jsx(Pe,{variant:S.Dots,gap:16,size:2})]})})}function Ge({id:t,data:s,sourcePosition:l,targetPosition:i}){var M;const{models:m,withColumns:r,handleClickModel:a,lineage:h={}}=P(),{model:u,columns:v}=n.useMemo(()=>{var c;const o=m.get(t),f=(o==null?void 0:o.columns)??[];return Object.keys(((c=h[t])==null?void 0:c.columns)??{}).forEach(C=>{const L=f.find(({name:E})=>E===C);ue(L)&&f.push({name:C,type:"UNKNOWN"})}),{model:o,columns:f}},[t,m,h]),p=n.useCallback(o=>{o.stopPropagation(),a==null||a(t)},[a,t,s.isInteractive]),j=Object.keys(s.highlightedNodes??{}).find(o=>s.highlightedNodes[o].includes(s.label)),N=(M=s.highlightedNodes)==null?void 0:M["*"],k=de(s.isInteractive)&&a!=null,b=s.type==="table",w=r&&V(v);return e.jsxs("div",{className:y("text-xs font-semibold rounded-xl shadow-lg relative z-1",j??N,b?"":"text-secondary-500 dark:text-primary-100"),children:[e.jsx("div",{className:"drag-handle",children:e.jsx(Ie,{id:t,type:u==null?void 0:u.type,label:s.label,className:y("py-2",w?"rounded-t-lg":"rounded-lg",b?"bg-neutral-600":"bg-secondary-100 dark:bg-primary-900"),hasLeft:l===A.Left,hasRight:i===A.Right,handleClick:k?p:void 0})}),w&&V(v)&&e.jsxs(e.Fragment,{children:[e.jsx(Oe,{className:"max-h-[15rem]",nodeId:t,columns:v,disabled:(u==null?void 0:u.type)==="python"||s.type!=="model",withHandles:!0}),e.jsx("div",{className:y("rounded-b-lg py-1",b?"bg-neutral-600":"bg-secondary-100 dark:bg-primary-900")})]})]})}export{Oe as M,We as a};
