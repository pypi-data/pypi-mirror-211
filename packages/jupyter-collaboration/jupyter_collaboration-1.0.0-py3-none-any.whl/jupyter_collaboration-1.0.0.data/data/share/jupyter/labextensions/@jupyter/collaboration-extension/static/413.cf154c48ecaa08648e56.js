"use strict";(self.webpackChunk_jupyter_collaboration_extension=self.webpackChunk_jupyter_collaboration_extension||[]).push([[413],{413:(e,s,n)=>{n.r(s),n.d(s,{WebsocketProvider:()=>A,messageAuth:()=>U,messageAwareness:()=>M,messageQueryAwareness:()=>I,messageSync:()=>C});var t=n(981),c=n(3205),a=n(6834),o=n(7225),i=n(5852);const r=new Map,d="undefined"==typeof BroadcastChannel?class{constructor(e){this.room=e,this.onmessage=null,this._onChange=s=>s.key===e&&null!==this.onmessage&&this.onmessage({data:o.Gh(s.newValue||"")}),i.z2(this._onChange)}postMessage(e){i.XN.setItem(this.room,o.s3(o.eh(e)))}close(){i.F(this._onChange)}}:BroadcastChannel,h=e=>c.Yu(r,e,(()=>{const s=a.Ue(),n=new d(e);return n.onmessage=e=>s.forEach((s=>s(e.data,"broadcastchannel"))),{bc:n,subs:s}})),l=(e,s,n=null)=>{const t=h(e);t.bc.postMessage(s),t.subs.forEach((e=>e(s,n)))};var u=n(870),w=n(9476),f=n(2256);const b=(e,s)=>{w.uE(e,0);const n=t.encodeStateVector(s);w.mP(e,n)},m=(e,s,n)=>{w.uE(e,1),w.mP(e,t.encodeStateAsUpdate(s,n))},y=(e,s,n)=>{try{t.applyUpdate(s,f.HN(e),n)}catch(e){console.error("Caught error while handling a Yjs update",e)}},_=y;var g=n(6493),p=n(2019),v=n(1332),E=n(9600),k=n(4406);const C=0,I=3,M=1,U=2,H=[];H[C]=(e,s,n,t,c)=>{w.uE(e,C);const a=((e,s,n,t)=>{const c=f.yg(e);switch(c){case 0:((e,s,n)=>{m(s,n,f.HN(e))})(e,s,n);break;case 1:y(e,n,t);break;case 2:_(e,n,t);break;default:throw new Error("Unknown message type")}return c})(s,e,n.doc,n);t&&1===a&&!n.synced&&(n.synced=!0)},H[I]=(e,s,n,t,c)=>{w.uE(e,M),w.mP(e,g.xq(n.awareness,Array.from(n.awareness.getStates().keys())))},H[M]=(e,s,n,t,c)=>{g.oy(n.awareness,f.HN(s),n)},H[U]=(e,s,n,t,c)=>{((e,s,n)=>{0===f.yg(e)&&n(0,f.kf(e))})(s,n.doc,((e,s)=>S(n,s)))};const S=(e,s)=>console.warn(`Permission denied to access ${e.url}.\n${s}`),x=(e,s,n)=>{const t=f.l1(s),c=w.Mf(),a=f.yg(t),o=e.messageHandlers[a];return o?o(c,t,e,n,a):console.error("Unable to compute message"),c},P=e=>{if(e.shouldConnect&&null===e.ws){const s=new e._WS(e.url);s.binaryType="arraybuffer",e.ws=s,e.wsconnecting=!0,e.wsconnected=!1,e.synced=!1,s.onmessage=n=>{e.wsLastMessageReceived=u.ZG();const t=x(e,new Uint8Array(n.data),!0);w.kE(t)>1&&s.send(w._f(t))},s.onerror=s=>{e.emit("connection-error",[s,e])},s.onclose=s=>{e.emit("connection-close",[s,e]),e.ws=null,e.wsconnecting=!1,e.wsconnected?(e.wsconnected=!1,e.synced=!1,g.Ag(e.awareness,Array.from(e.awareness.getStates().keys()).filter((s=>s!==e.doc.clientID)),e),e.emit("status",[{status:"disconnected"}])):e.wsUnsuccessfulReconnects++,setTimeout(P,v.VV(100*v.sQ(2,e.wsUnsuccessfulReconnects),e.maxBackoffTime),e)},s.onopen=()=>{e.wsLastMessageReceived=u.ZG(),e.wsconnecting=!1,e.wsconnected=!0,e.wsUnsuccessfulReconnects=0,e.emit("status",[{status:"connected"}]);const n=w.Mf();if(w.uE(n,C),b(n,e.doc),s.send(w._f(n)),null!==e.awareness.getLocalState()){const n=w.Mf();w.uE(n,M),w.mP(n,g.xq(e.awareness,[e.doc.clientID])),s.send(w._f(n))}},e.emit("status",[{status:"connecting"}])}},B=(e,s)=>{const n=e.ws;e.wsconnected&&n&&n.readyState===n.OPEN&&n.send(s),e.bcconnected&&l(e.bcChannel,s,e)};class A extends p.y{constructor(e,s,n,{connect:t=!0,awareness:c=new g.GL(n),params:a={},WebSocketPolyfill:o=WebSocket,resyncInterval:i=-1,maxBackoffTime:r=2500,disableBc:d=!1}={}){for(super();"/"===e[e.length-1];)e=e.slice(0,e.length-1);const h=(e=>E.UI(e,((e,s)=>`${encodeURIComponent(s)}=${encodeURIComponent(e)}`)).join("&"))(a);this.maxBackoffTime=r,this.bcChannel=e+"/"+s,this.url=e+"/"+s+(0===h.length?"":"?"+h),this.roomname=s,this.doc=n,this._WS=o,this.awareness=c,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=d,this.wsUnsuccessfulReconnects=0,this.messageHandlers=H.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=t,this._resyncInterval=0,i>0&&(this._resyncInterval=setInterval((()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){const e=w.Mf();w.uE(e,C),b(e,n),this.ws.send(w._f(e))}}),i)),this._bcSubscriber=(e,s)=>{if(s!==this){const s=x(this,new Uint8Array(e),!1);w.kE(s)>1&&l(this.bcChannel,w._f(s),this)}},this._updateHandler=(e,s)=>{if(s!==this){const s=w.Mf();w.uE(s,C),((e,s)=>{w.uE(e,2),w.mP(e,s)})(s,e),B(this,w._f(s))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:e,updated:s,removed:n},t)=>{const a=e.concat(s).concat(n),o=w.Mf();w.uE(o,M),w.mP(o,g.xq(c,a)),B(this,w._f(o))},this._unloadHandler=()=>{g.Ag(this.awareness,[n.clientID],"window unload")},"undefined"!=typeof window?window.addEventListener("unload",this._unloadHandler):void 0!==k&&k.on("exit",this._unloadHandler),c.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval((()=>{this.wsconnected&&3e4<u.ZG()-this.wsLastMessageReceived&&this.ws.close()}),3e3),t&&this.connect()}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e,this.emit("synced",[e]),this.emit("sync",[e]))}destroy(){0!==this._resyncInterval&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),"undefined"!=typeof window?window.removeEventListener("unload",this._unloadHandler):void 0!==k&&k.off("exit",this._unloadHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;var e,s;this.bcconnected||(e=this.bcChannel,s=this._bcSubscriber,h(e).subs.add(s),this.bcconnected=!0);const n=w.Mf();w.uE(n,C),b(n,this.doc),l(this.bcChannel,w._f(n),this);const t=w.Mf();w.uE(t,C),m(t,this.doc),l(this.bcChannel,w._f(t),this);const c=w.Mf();w.uE(c,I),l(this.bcChannel,w._f(c),this);const a=w.Mf();w.uE(a,M),w.mP(a,g.xq(this.awareness,[this.doc.clientID])),l(this.bcChannel,w._f(a),this)}disconnectBc(){const e=w.Mf();w.uE(e,M),w.mP(e,g.xq(this.awareness,[this.doc.clientID],new Map)),B(this,w._f(e)),this.bcconnected&&(((e,s)=>{const n=h(e);n.subs.delete(s)&&0===n.subs.size&&(n.bc.close(),r.delete(e))})(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),null!==this.ws&&this.ws.close()}connect(){this.shouldConnect=!0,this.wsconnected||null!==this.ws||(P(this),this.connectBc())}}}}]);