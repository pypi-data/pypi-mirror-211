apiVersion: elbv2.aws.infra/v1alpha1
kind: LoadBalancer
pipelineConfig:
  no-apply: true
  comment: 'no-apply: true prevents this file being apply by infra-operator. auto
    added by infra-operator export. if need to apply, set to false'
metadata:
  Type: application
  Name: bin-dev-comb-1-alb
  VpcId: vpc-06e7bab377f9cb4e9
  Scheme: internal
  IpAddressType: ipv4
  Tags:
    prow-pipeline: y
    biz: common-infra
    engine: devops-infra
    devops-infra-service: comb-1
    terraform: y
    team: devops
    message: managed by https://git.toolsfdg.net/devops/devops-infra
  Attributes:
    access_logs.s3.enabled: 'false'
    access_logs.s3.bucket: ''
    access_logs.s3.prefix: ''
    idle_timeout.timeout_seconds: '66'
    deletion_protection.enabled: 'false'
    routing.http2.enabled: 'true'
    routing.http.drop_invalid_header_fields.enabled: 'false'
    routing.http.xff_client_port.enabled: 'false'
    routing.http.preserve_host_header.enabled: 'true'
    routing.http.xff_header_processing.mode: append
    load_balancing.cross_zone.enabled: 'true'
    routing.http.desync_mitigation_mode: defensive
    waf.fail_open.enabled: 'false'
    routing.http.x_amzn_tls_version_and_cipher_suite.enabled: 'false'
spec:
  Subnets:
    - subnet-005223e14aa168a2c
    - subnet-0e5d061593dd742a0
    - subnet-0f7c148c34aff7ba0
  SecurityGroups:
    - $file(alb.sg.yaml)
  Listeners:
    - Protocol: HTTP
      Port: 80
      DefaultActions:
        - Type: redirect
          Order: 1
          RedirectConfig:
            Port: '443'
            Host: '#{host}'
            Path: /#{path}
            Query: '#{query}'
            Protocol: HTTPS
            StatusCode: HTTP_302
      Rules:
        - Priority: 2
          Conditions:
            - Field: host-header
              Values:
                - www.devfdg.net
                - www.fe.devfdg.net
            - Field: http-header
              HttpHeaderConfig:
                HttpHeaderName: ABC
                Values:
                  - ddddd
            - Field: path-pattern
              Values:
                - /hello
          Actions:
            - Type: forward
              Order: 1
              ForwardConfig:
                TargetGroupStickinessConfig:
                  Enabled: false
                TargetGroups:
                  - TargetGroupArn: $file(targetGroup.yaml)
                    Weight: 1
    - Protocol: HTTPS
      SslPolicy: ELBSecurityPolicy-2016-08
      Port: 443
      Certificates:
        - CertificateArn: arn:aws:acm:ap-northeast-1:173062506398:certificate/c1092697-0b35-4f44-a1b2-2df881888b1d
      DefaultActions:
        - Type: fixed-response
          Order: 1
          FixedResponseConfig:
            StatusCode: '403'
            MessageBody: Forbiden
            ContentType: text/plain
      Rules:
        - Priority: 2
          Conditions:
            - Field: host-header
              Values:
                - www.devfdg.net
                - www.fe.devfdg.net
            - Field: http-header
              HttpHeaderConfig:
                HttpHeaderName: ABC
                Values:
                  - GGGGGG
            - Field: path-pattern
              Values:
                - /en/*
          Actions:
            - Type: forward
              Order: 1
              ForwardConfig:
                TargetGroupStickinessConfig:
                  Enabled: false
                TargetGroups:
                  - TargetGroupArn: $file(targetGroup.yaml)
                    Weight: 1
