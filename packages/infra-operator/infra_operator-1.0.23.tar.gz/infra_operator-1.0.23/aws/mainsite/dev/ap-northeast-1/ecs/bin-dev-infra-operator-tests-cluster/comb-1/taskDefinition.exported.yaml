apiVersion: ecs.aws.infra/v1alpha1
kind: TaskDefinition
pipelineConfig:
  no-apply: true
  comment: 'no-apply: true prevents this file being apply by infra-operator. auto
    added by infra-operator export. if need to apply, set to false'
metadata:
  cpu: '1024'
  family: bin-dev-comb-1
  memory: '4096'
  taskRoleArn: arn:aws:iam::173062506398:role/bin_dev_comb_1_ecs_task_role
  networkMode: awsvpc
  executionRoleArn: arn:aws:iam::173062506398:role/bin_comb_1_ecs_exec_role
spec:
  requiresCompatibilities:
    - FARGATE
  containerDefinitions:
    - name: main
      image: 918323888678.dkr.ecr.ap-northeast-1.amazonaws.com/dom-d/hello-world:6cb3289f740d4bd0c2fee300689aac0b4c22748d
      essential: true
      cpu: 1024
      command:
        - nginx
        - -g
        - daemon off;
      stopTimeout: 60
      startTimeout: 10
      memoryReservation: 2049
      dependsOn:
        - condition: HEALTHY
          containerName: log_router
      environment:
        - name: A
          value: G
        - name: E
          value: F
        - name: C
          value: D
      healthCheck:
        command:
          - CMD-SHELL
          - curl -f http://localhost || exit 1
        timeout: 2
        retries: 3
        interval: 5
        startPeriod: 2
      logConfiguration:
        logDriver: awsfirelens
        options:
          Name: kafka
          Match: '*'
          Format: json
          Topics: ecs-fe-logs
          Brokers: kafka-log1.devfdg.net:9092,kafka-log2.devfdg.net:9092,kafka-log3.devfdg.net:9092
      ulimits:
        - name: nofile
          softLimit: 65535
          hardLimit: 65535
      portMappings:
        - protocol: tcp
          hostPort: 80
          containerPort: 80
    - name: log_router
      user: '0'
      image: 906394416424.dkr.ecr.ap-northeast-1.amazonaws.com/aws-for-fluent-bit:latest
      essential: true
      cpu: 0
      firelensConfiguration:
        type: fluentbit
      healthCheck:
        command:
          - CMD-SHELL
          - echo hello
        timeout: 2
        retries: 3
        interval: 5
        startPeriod: 2
      logConfiguration:
        logDriver: awslogs
        options:
          awslogs-group: bin-dev-ecs-firelens
          awslogs-region: ap-northeast-1
          awslogs-create-group: 'true'
          awslogs-stream-prefix: /bin-dev-comb-1-firelens
    - name: aws-collector
      image: 918323888678.dkr.ecr.ap-northeast-1.amazonaws.com/devops/aws-otel-collector:2ce592eb2d378913a1190c842c4ef24cb6c1024b
      essential: true
      cpu: 0
      command:
        - --config=/etc/ecs/ecs-amp-prom.yaml
      environment:
        - name: AWS_PROMETHEUS_ENDPOINT
          value: http://nonprod-dev.vminsert.internal:80/insert/0/prometheus
      logConfiguration:
        logDriver: awslogs
        options:
          awslogs-group: bin-dev-ecs
          awslogs-region: ap-northeast-1
          awslogs-create-group: 'true'
          awslogs-stream-prefix: /bin-dev-comb-1
